<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>DDL Scolia League</title>

<style>
:root { color-scheme: dark; }

body{
  margin:0;
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  background: radial-gradient(circle at top, #0f1b33, #050914);
  color:#e5e7eb;
}

.wrap{ max-width: 1050px; margin: auto; padding: 26px; }

header{ text-align:center; margin-bottom: 26px; }

.logo{
  display:block;
  margin: 0 auto 12px;
  max-width: 160px;
  width:100%;
  height:auto;
}

h1{ margin:0 0 6px; font-size: 28px; }
.sub{ opacity:.8; font-size: 14px; }

.section{
  background: linear-gradient(180deg, #0e1930, #0b1220);
  border: 1px solid #1f2a44;
  border-radius: 18px;
  padding: 18px;
  margin-bottom: 22px;
  box-shadow: 0 20px 50px rgba(0,0,0,.4);
}

.section h2{ margin: 0 0 14px; font-size: 18px; }

.grid2{ display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
@media (max-width: 900px){ .grid2{ grid-template-columns: 1fr; } }

table{
  width:100%;
  border-collapse: collapse;
  font-size: 14px;
}

th, td{
  padding: 10px 8px;
  text-align:center;
}

th{
  background:#111c36;
  font-weight: 600;
  text-transform: uppercase;
  font-size: 12px;
  letter-spacing: .05em;
}

td{
  border-bottom: 1px solid #1f2a44;
}

tbody tr:hover{ background: rgba(148,163,184,.08); }

td:first-child, th:first-child{
  text-align:left;
  padding-left: 12px;
}

.pill{
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding: 6px 10px;
  border-radius: 999px;
  font-size: 12px;
  white-space:nowrap;
}

.pill.played{
  background: rgba(34,197,94,.15);
  border:1px solid rgba(34,197,94,.35);
}

.pill.tbp{
  background: rgba(239,68,68,.15);
  border:1px solid rgba(239,68,68,.35);
}

.toolbar{
  display:flex;
  justify-content: space-between;
  align-items:center;
  gap:10px;
  margin-bottom: 12px;
  flex-wrap: wrap;
}

select, button{
  background:#0b1220;
  color:#e5e7eb;
  border:1px solid #263554;
  border-radius: 12px;
  padding: 8px 12px;
  cursor:pointer;
}

button:hover{ background:#101a33; }

.muted{ opacity:.75; font-size: 12px; }
</style>
</head>

<body>
<div class="wrap">

<header>
  <img class="logo" src="https://i.postimg.cc/wTwzxQT3/DDL.png" alt="DDL">
  <h1>DDL Scolia League</h1>
  <div class="sub">Live standings, averages & fixtures</div>
</header>

<div class="grid2">
  <section class="section">
    <h2>üèÜ League Table</h2>
    <div id="league">Loading‚Ä¶</div>
  </section>

  <section class="section">
    <h2>üéØ Player Averages</h2>
    <div id="averages">Loading‚Ä¶</div>
  </section>
</div>

<section class="section">
  <h2>üóìÔ∏è Fixtures</h2>

  <div class="toolbar">
    <div>
      <select id="weekSelect"></select>
      <span class="muted" id="weekSummary"></span>
    </div>
    <button id="refreshBtn">Refresh</button>
  </div>

  <div id="fixtures">Loading‚Ä¶</div>
</section>

</div>

<script>
/** CONFIG **/
const PUBLISHED_ID  = "2PACX-1vTVhX-SEr3O85L6si4hEs6_XvTuSTXsLS20qVhfLcf_HfHEmgH_7VMFy8dGlALfFOgeHGnX8ZpFkTMg";
const LEAGUE_GID    = "372981515";
const AVERAGES_GID  = "505988321";
const FIXTURES_GID  = "309782021";

/** Helpers **/
function csvUrl(gid){
  return `https://docs.google.com/spreadsheets/d/e/${PUBLISHED_ID}/pub?gid=${gid}&single=true&output=csv`;
}

// Robust CSV parsing (handles commas inside quotes)
function parseCSV(text){
  const rows = [];
  let row = [], cur = "", inQuotes = false;

  for (let i = 0; i < text.length; i++){
    const c = text[i];
    const next = text[i+1];

    if (c === '"' && inQuotes && next === '"'){ cur += '"'; i++; continue; }
    if (c === '"'){ inQuotes = !inQuotes; continue; }

    if (c === "," && !inQuotes){ row.push(cur); cur=""; continue; }

    if ((c === "\n" || c === "\r") && !inQuotes){
      if (cur.length || row.length){ row.push(cur); rows.push(row); }
      row = []; cur = "";
      if (c === "\r" && next === "\n") i++;
      continue;
    }

    cur += c;
  }
  if (cur.length || row.length){ row.push(cur); rows.push(row); }
  return rows.filter(r => r.some(cell => String(cell).trim() !== ""));
}

function esc(s){
  return String(s ?? "").replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  })[m]);
}

function renderTable(rows, elId){
  if (!rows || rows.length < 2){
    document.getElementById(elId).innerHTML = `<div class="muted">No data.</div>`;
    return;
  }

  let html = `<table><thead><tr>`;
  rows[0].forEach(h => html += `<th>${esc(h)}</th>`);
  html += `</tr></thead><tbody>`;

  rows.slice(1).forEach(r => {
    html += `<tr>`;
    rows[0].forEach((_, i) => html += `<td>${esc(r[i] ?? "")}</td>`);
    html += `</tr>`;
  });

  html += `</tbody></table>`;
  document.getElementById(elId).innerHTML = html;
}

function pill(status){
  const s = String(status || "").toLowerCase();
  if (s.includes("played")) return `<span class="pill played">‚úÖ Game Played</span>`;
  return `<span class="pill tbp">‚è≥ To Be Played</span>`;
}

/**
 * FIXED Fixtures renderer:
 * - Works even if your sheet has blank columns (e.g. Match in A, Home in C, Away in D)
 * - Shows only the selected matchweek
 * - Played count is per-week, not overall
 * - Released = Yes on ONE row releases the whole week
 */
function renderFixtures(rows){
  const headers = rows[0].map(h => String(h || "").trim());

  const colExact = (name) => headers.findIndex(h => h.toLowerCase() === name);
  const colContains = (txt) => headers.findIndex(h => h.toLowerCase().includes(txt));

  const iMatch   = colExact("match");
  const iHome    = colExact("home");
  const iAway    = colExact("away");
  const iStatus  = colExact("status");
  const iRelease = colContains("release");

  if (iMatch === -1 || iHome === -1 || iAway === -1 || iStatus === -1 || iRelease === -1) {
    document.getElementById("fixtures").innerHTML =
      `<div class="muted">Fixtures headers not found. Ensure headers include: Match, Home, Away, Status, Released.</div>`;
    return;
  }

  const data = rows.slice(1)
    .filter(r => String(r[iMatch] ?? "").trim() !== "")
    .map(r => ({
      match: String(r[iMatch] ?? "").trim(),
      home:  String(r[iHome] ?? "").trim(),
      away:  String(r[iAway] ?? "").trim(),
      status: String(r[iStatus] ?? "").trim(),
      released: String(r[iRelease] ?? "").trim().toLowerCase()
    }));

  // ANY row in a week marked "Yes" releases the WHOLE week
  const releasedWeeks = [...new Set(
    data.filter(d => ["yes","true","y","1"].includes(d.released)).map(d => d.match)
  )].sort((a,b) => (Number(a) - Number(b)));

  const select = document.getElementById("weekSelect");

  if (!releasedWeeks.length) {
    select.innerHTML = `<option value="">No fixtures released</option>`;
    document.getElementById("weekSummary").textContent = "";
    document.getElementById("fixtures").innerHTML = `<div class="muted">No fixtures released yet.</div>`;
    return;
  }

  select.innerHTML = releasedWeeks.map(w => `<option value="${esc(w)}">Match ${esc(w)}</option>`).join("");

  function draw(){
    const week = select.value || releasedWeeks[0];
    const weekRows = data.filter(d => d.match === week);

    const played = weekRows.filter(d => String(d.status).toLowerCase().includes("played")).length;
    document.getElementById("weekSummary").textContent = `Played: ${played}/${weekRows.length}`;

    let html = `<table><thead><tr>
      <th>Match</th><th>Home</th><th>Away</th><th>Status</th>
    </tr></thead><tbody>`;

    weekRows.forEach(r => {
      html += `<tr>
        <td>${esc(r.match)}</td>
        <td>${esc(r.home)}</td>
        <td>${esc(r.away)}</td>
        <td>${pill(r.status)}</td>
      </tr>`;
    });

    html += `</tbody></table>`;
    document.getElementById("fixtures").innerHTML = html;
  }

  select.onchange = draw;
  draw();
}

async function loadAll(){
  try {
    const leagueCSV = await fetch(csvUrl(LEAGUE_GID), {cache:"no-store"}).then(r => r.text());
    renderTable(parseCSV(leagueCSV), "league");

    const avgCSV = await fetch(csvUrl(AVERAGES_GID), {cache:"no-store"}).then(r => r.text());
    renderTable(parseCSV(avgCSV), "averages");

    const fixCSV = await fetch(csvUrl(FIXTURES_GID), {cache:"no-store"}).then(r => r.text());
    renderFixtures(parseCSV(fixCSV));
  } catch (e) {
    document.getElementById("fixtures").innerHTML =
      `<div class="muted">Error loading fixtures. Try Refresh. (${esc(e.message)})</div>`;
  }
}

document.getElementById("refreshBtn").addEventListener("click", loadAll);
loadAll();
</script>

</body>
</html>
