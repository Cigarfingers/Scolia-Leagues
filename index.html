<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>DDL Scolia League</title>

<style>
:root { color-scheme: dark; }

body{
  margin:0;
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  background: radial-gradient(circle at top, #0f1b33, #050914);
  color:#e5e7eb;
}

.wrap{ max-width: 1050px; margin: auto; padding: 26px; }

header{ text-align:center; margin-bottom: 26px; }

.logo{
  display:block;
  margin: 0 auto 12px;
  max-width: 160px;
  width:100%;
  height:auto;
}

h1{ margin:0 0 6px; font-size: 28px; }
.sub{ opacity:.8; font-size: 14px; }

.section{
  background: linear-gradient(180deg, #0e1930, #0b1220);
  border: 1px solid #1f2a44;
  border-radius: 18px;
  padding: 18px;
  margin-bottom: 22px;
  box-shadow: 0 20px 50px rgba(0,0,0,.4);
}

.section h2{ margin: 0 0 14px; font-size: 18px; display:flex; align-items:center; gap:10px; }

.grid2{ display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
@media (max-width: 900px){ .grid2{ grid-template-columns: 1fr; } }

table{
  width:100%;
  border-collapse: collapse;
  font-size: 14px;
}

th, td{
  padding: 10px 8px;
  text-align:center;
}

th{
  background:#111c36;
  font-weight: 600;
  text-transform: uppercase;
  font-size: 12px;
  letter-spacing: .05em;
}

td{
  border-bottom: 1px solid #1f2a44;
}

tbody tr:hover{ background: rgba(148,163,184,.08); }

td:first-child, th:first-child{
  text-align:left;
  padding-left: 12px;
}

.pill{
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding: 6px 10px;
  border-radius: 999px;
  font-size: 12px;
  white-space:nowrap;
}

.pill.played{
  background: rgba(34,197,94,.15);
  border:1px solid rgba(34,197,94,.35);
}

.pill.tbp{
  background: rgba(239,68,68,.15);
  border:1px solid rgba(239,68,68,.35);
}

.toolbar{
  display:flex;
  justify-content: space-between;
  align-items:center;
  gap:10px;
  margin-bottom: 12px;
  flex-wrap: wrap;
}

select, button{
  background:#0b1220;
  color:#e5e7eb;
  border:1px solid #263554;
  border-radius: 12px;
  padding: 8px 12px;
  cursor:pointer;
}

button:hover{ background:#101a33; }
.muted{ opacity:.75; font-size: 12px; }

.clickable{
  cursor:pointer;
  color:#c7d2fe;
  text-decoration: underline;
  text-decoration-color: rgba(199,210,254,.35);
  text-underline-offset: 3px;
}
.clickable:hover{
  color:#ffffff;
  text-decoration-color: rgba(255,255,255,.55);
}

/* Leaderboards */
.lists{
  display:grid;
  grid-template-columns: repeat(3, minmax(0, 1fr));
  gap: 12px;
}
@media (max-width: 900px){ .lists{ grid-template-columns: 1fr; } }

.panel{
  border: 1px solid #1f2a44;
  border-radius: 14px;
  background: rgba(17,28,54,.35);
  padding: 12px;
}
.panel h3{
  margin: 0 0 10px;
  font-size: 14px;
  opacity: .9;
  display:flex;
  align-items:center;
  gap:8px;
}
.ranklist{ margin:0; padding:0; list-style:none; }
.ranklist li{
  display:flex;
  justify-content: space-between;
  gap: 10px;
  padding: 8px 6px;
  border-bottom: 1px solid rgba(31,42,68,.6);
}
.ranklist li:last-child{ border-bottom:none; }
.badge{
  font-size: 12px;
  opacity:.85;
  border: 1px solid rgba(38,53,84,.9);
  padding: 3px 8px;
  border-radius: 999px;
  background: rgba(11,18,32,.6);
}

/* Modal */
.modal-backdrop{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.55);
  display:none;
  align-items: center;
  justify-content: center;
  padding: 18px;
  z-index: 9999;
}
.modal{
  width: 100%;
  max-width: 760px;
  background: linear-gradient(180deg, #0e1930, #0b1220);
  border: 1px solid #1f2a44;
  border-radius: 18px;
  box-shadow: 0 30px 80px rgba(0,0,0,.6);
  overflow:hidden;
}
.modal-header{
  display:flex;
  justify-content: space-between;
  align-items:center;
  padding: 14px 16px;
  border-bottom: 1px solid rgba(31,42,68,.7);
}
.modal-title{
  display:flex;
  flex-direction: column;
  gap: 2px;
}
.modal-title strong{ font-size: 16px; }
.modal-title span{ font-size: 12px; opacity:.75; }
.modal-close{
  border-radius: 12px;
  padding: 8px 10px;
}
.modal-body{ padding: 14px 16px; }

.profile-grid{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
}
@media (max-width: 800px){ .profile-grid{ grid-template-columns: 1fr; } }

.kpi{
  border: 1px solid rgba(31,42,68,.7);
  border-radius: 14px;
  padding: 12px;
  background: rgba(17,28,54,.28);
}
.kpi h4{ margin:0 0 8px; font-size: 13px; opacity:.85; }
.kpi .rows{ display:grid; gap: 8px; }
.kpi .row{ display:flex; justify-content: space-between; gap: 10px; }
.kpi .row span:first-child{ opacity:.8; }
.kpi .row span:last-child{ font-weight: 650; }

.error{
  padding: 12px 14px;
  border-radius: 12px;
  border: 1px solid rgba(239,68,68,.35);
  background: rgba(239,68,68,.12);
}
</style>
</head>

<body>
<div class="wrap">

<header>
  <img class="logo" src="https://i.postimg.cc/wTwzxQT3/DDL.png" alt="DDL">
  <h1>DDL Scolia League</h1>
  <div class="sub">Live standings, averages & fixtures</div>
</header>

<div class="grid2">
  <section class="section">
    <h2>üèÜ League Table</h2>
    <div id="league">Loading‚Ä¶</div>
  </section>

  <section class="section">
    <h2>üéØ Player Averages</h2>
    <div id="averages">Loading‚Ä¶</div>
  </section>
</div>

<section class="section">
  <h2>üî• Player Records</h2>
  <div class="lists" id="records">Loading‚Ä¶</div>
</section>

<section class="section">
  <h2>üì£ League Highlights</h2>
  <div class="lists" id="highlights">Loading‚Ä¶</div>
  <div class="muted" id="highlightsRange" style="margin-top:10px;"></div>
</section>

<section class="section">
  <h2>üóìÔ∏è Fixtures</h2>

  <div class="toolbar">
    <div>
      <select id="weekSelect"></select>
      <span class="muted" id="weekSummary"></span>
    </div>
    <button id="refreshBtn">Refresh</button>
  </div>

  <div id="fixtures">Loading‚Ä¶</div>
</section>

</div>

<!-- Player Modal -->
<div class="modal-backdrop" id="modalBackdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-label="Player Profile">
    <div class="modal-header">
      <div class="modal-title">
        <strong id="modalName">Player</strong>
        <span id="modalSub">Player Profile</span>
      </div>
      <button class="modal-close" id="modalClose" type="button">Close</button>
    </div>
    <div class="modal-body" id="modalBody">
      Loading‚Ä¶
    </div>
  </div>
</div>

<script>
/** CONFIG **/
const PUBLISHED_ID  = "2PACX-1vTVhX-SEr3O85L6si4hEs6_XvTuSTXsLS20qVhfLcf_HfHEmgH_7VMFy8dGlALfFOgeHGnX8ZpFkTMg";

const LEAGUE_GID    = "372981515";
const AVERAGES_GID  = "505988321";
const FIXTURES_GID  = "309782021";
const RESULTS_GID   = "1902038275";

const PLAYER_STATS_GID = "1551531980";
const STAT_ENTRY_GID   = "1520567528";

/** Helpers **/
function csvUrl(gid){
  return `https://docs.google.com/spreadsheets/d/e/${PUBLISHED_ID}/pub?gid=${gid}&single=true&output=csv`;
}

// Robust CSV parser
function parseCSV(text){
  const rows = [];
  let row = [], cur = "", inQuotes = false;

  for (let i = 0; i < text.length; i++){
    const c = text[i];
    const next = text[i+1];

    if (c === '"' && inQuotes && next === '"'){ cur += '"'; i++; continue; }
    if (c === '"'){ inQuotes = !inQuotes; continue; }

    if (c === "," && !inQuotes){ row.push(cur); cur=""; continue; }

    if ((c === "\n" || c === "\r") && !inQuotes){
      if (cur.length || row.length){ row.push(cur); rows.push(row); }
      row = []; cur = "";
      if (c === "\r" && next === "\n") i++;
      continue;
    }
    cur += c;
  }
  if (cur.length || row.length){ row.push(cur); rows.push(row); }
  return rows.filter(r => r.some(cell => String(cell).trim() !== ""));
}

function esc(s){
  return String(s ?? "").replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  })[m]);
}

function normaliseStatus(status){
  return String(status ?? "").trim().toLowerCase().replace(/\s+/g, " ");
}
function isGamePlayed(status){
  return normaliseStatus(status) === "game played";
}
function pill(status){
  return isGamePlayed(status)
    ? `<span class="pill played">‚úÖ Game Played</span>`
    : `<span class="pill tbp">‚è≥ To Be Played</span>`;
}

// Click handler for player names anywhere
function makePlayerClickable(name){
  const safe = esc(name);
  return `<span class="clickable" data-player="${safe}">${safe}</span>`;
}

// Render generic table, optionally making a specific header column clickable (e.g. PLAYER)
function renderTable(rows, elId, clickableHeaderNamesLower = []){
  if (!rows || rows.length < 2){
    document.getElementById(elId).innerHTML = `<div class="muted">No data.</div>`;
    return;
  }

  const headers = rows[0].map(h => String(h||"").trim());
  const clickableCols = new Set();
  headers.forEach((h, i) => {
    if (clickableHeaderNamesLower.includes(h.toLowerCase())) clickableCols.add(i);
  });

  let html = `<table><thead><tr>`;
  headers.forEach(h => html += `<th>${esc(h)}</th>`);
  html += `</tr></thead><tbody>`;

  rows.slice(1).forEach(r => {
    html += `<tr>`;
    headers.forEach((_, i) => {
      const v = String(r[i] ?? "");
      const cell = clickableCols.has(i) ? makePlayerClickable(v) : esc(v);
      html += `<td>${cell}</td>`;
    });
    html += `</tr>`;
  });

  html += `</tbody></table>`;
  document.getElementById(elId).innerHTML = html;
}

/** Fixtures renderer (handles blank columns + Released gating) **/
function renderFixtures(rows){
  const headers = rows[0].map(h => String(h || "").trim());
  const colExact = (name) => headers.findIndex(h => h.toLowerCase() === name);
  const colContains = (txt) => headers.findIndex(h => h.toLowerCase().includes(txt));

  const iMatch   = colExact("match");
  const iHome    = colExact("home");
  const iAway    = colExact("away");
  const iStatus  = colExact("status");
  const iRelease = colContains("release");

  const data = rows.slice(1)
    .filter(r => String(r[iMatch] ?? "").trim() !== "")
    .map(r => ({
      match: String(r[iMatch] ?? "").trim(),
      home:  String(r[iHome] ?? "").trim(),
      away:  String(r[iAway] ?? "").trim(),
      status: String(r[iStatus] ?? "").trim(),
      released: String(r[iRelease] ?? "").trim().toLowerCase()
    }));

  const releasedWeeks = [...new Set(
    data.filter(d => ["yes","true","y","1"].includes(d.released)).map(d => d.match)
  )].sort((a,b) => (Number(a) - Number(b)));

  const select = document.getElementById("weekSelect");
  if (!releasedWeeks.length) {
    select.innerHTML = `<option value="">No fixtures released</option>`;
    document.getElementById("weekSummary").textContent = "";
    document.getElementById("fixtures").innerHTML = `<div class="muted">No fixtures released yet.</div>`;
    return;
  }

  select.innerHTML = releasedWeeks.map(w => `<option value="${esc(w)}">Match ${esc(w)}</option>`).join("");

  function draw(){
    const week = select.value || releasedWeeks[0];
    const weekRows = data.filter(d => d.match === week);

    const played = weekRows.filter(d => isGamePlayed(d.status)).length;
    document.getElementById("weekSummary").textContent = `Played: ${played}/${weekRows.length}`;

    let html = `<table><thead><tr>
      <th>Match</th><th>Home</th><th>Away</th><th>Status</th>
    </tr></thead><tbody>`;

    weekRows.forEach(r => {
      html += `<tr>
        <td>${esc(r.match)}</td>
        <td>${makePlayerClickable(r.home)}</td>
        <td>${makePlayerClickable(r.away)}</td>
        <td>${pill(r.status)}</td>
      </tr>`;
    });

    html += `</tbody></table>`;
    document.getElementById("fixtures").innerHTML = html;
  }

  select.onchange = draw;
  draw();
}

/** Player Stats parsing + robust header matching **/
function rowsToObjects(rows){
  const headers = rows[0].map(h => String(h || "").trim()); // TRIM headers
  return rows.slice(1).map(r => {
    const o = {};
    headers.forEach((h, i) => o[h] = r[i] ?? "");
    return o;
  });
}
function num(x){
  const n = Number(String(x ?? "").trim().replace("%",""));
  return Number.isFinite(n) ? n : 0;
}

/** Checkout helpers (site displays % only) **/
function pct(made, att){
  const m = num(made), a = num(att);
  if (a <= 0) return null;
  return (m / a) * 100;
}
function fmtPct(v, decimals = 2){
  if (v === null || v === undefined || !Number.isFinite(v)) return "‚Äî";
  return `${v.toFixed(decimals)}%`;
}

/** Robust key fetch (used in highlights + modal checkout from stat entry) **/
function normKey(s){
  return String(s ?? "").toLowerCase().replace(/[^a-z0-9]+/g, "");
}
function getAny(o, candidates){
  const keys = Object.keys(o);
  for (const cand of candidates){
    const target = normKey(cand);
    const hit = keys.find(k => normKey(k) === target);
    if (hit) return o[hit];
  }
  return "";
}

/** Records **/
function renderRecords(playerStatsObjects){
  const get = (obj, key) => obj[key] ?? obj[key.toUpperCase()] ?? obj[key.toLowerCase()] ?? "";

  const leaderboard = (title, emoji, valueKey, dir = "desc", limit=5, isBestLeg=false) => {
    const items = playerStatsObjects
      .map(p => ({
        player: get(p, "Player"),
        val: num(get(p, valueKey))
      }))
      .filter(x => x.player && (isBestLeg ? x.val > 0 : true))
      .sort((a,b) => dir === "asc" ? (a.val - b.val) : (b.val - a.val))
      .slice(0, limit);

    const lis = items.map((x, i) => `
      <li>
        <span>${i+1}. ${makePlayerClickable(x.player)}</span>
        <span class="badge">${esc(x.val)}</span>
      </li>
    `).join("");

    return `
      <div class="panel">
        <h3>${emoji} ${esc(title)}</h3>
        <ul class="ranklist">${lis || `<li><span class="muted">No data yet</span><span></span></li>`}</ul>
      </div>
    `;
  };

  const html =
    leaderboard("Most 180s", "üí•", "180", "desc") +
    leaderboard("Most 140+", "üî•", "140+", "desc") +
    leaderboard("Most 100+", "üéØ", "100+", "desc") +
    leaderboard("Highest Finish", "üèÜ", "Highest Finish", "desc") +
    leaderboard("Best Leg (Lowest)", "‚ö°", "Best Leg", "asc", 5, true);

  document.getElementById("records").innerHTML = html;
}

/** League Highlights (from Stat Entry, overall) **/
function renderLeagueHighlights(statEntryRows){
  const objs = rowsToObjects(statEntryRows);

  const all = objs
    .map(o => ({
      player: String(getAny(o, ["Player"]) || "").trim(),
      s100: num(getAny(o, ["100+","100 +"])),
      s140: num(getAny(o, ["140+","140 +"])),
      s180: num(getAny(o, ["180"])),
      hf:   num(getAny(o, ["Highest Finish","High Finish"])),
      bl:   num(getAny(o, ["Best Leg","Best Leg (Lowest)"])),
      cm:   num(getAny(o, ["Checkout Made","Checkouts Made"])),
      ca:   num(getAny(o, ["Checkout Attempts","Checkouts Attempted","Checkout Attempted"])),
    }))
    .filter(x => x.player);

  document.getElementById("highlightsRange").textContent = `Overall (all logged Stat Entry rows)`;

  if (!all.length){
    document.getElementById("highlights").innerHTML =
      `<div class="panel"><h3>‚ÑπÔ∏è No stats logged yet</h3><div class="muted">Add rows in Stat Entry and it will populate automatically.</div></div>`;
    return;
  }

  const agg = new Map();
  for (const r of all){
    if (!agg.has(r.player)){
      agg.set(r.player, {player:r.player, s100:0, s140:0, s180:0, hf:0, bl: null, cm:0, ca:0});
    }
    const a = agg.get(r.player);
    a.s100 += r.s100;
    a.s140 += r.s140;
    a.s180 += r.s180;
    a.hf = Math.max(a.hf, r.hf || 0);
    if (r.bl > 0) a.bl = (a.bl === null) ? r.bl : Math.min(a.bl, r.bl);
    a.cm += r.cm;
    a.ca += r.ca;
  }
  const arr = [...agg.values()];

  const topOne = (title, emoji, accessor, formatter = (v)=>v, dir="desc") => {
    const sorted = [...arr].sort((x,y) => {
      const ax = accessor(x), ay = accessor(y);
      if (dir === "asc") return (ax ?? 1e9) - (ay ?? 1e9);
      return (ay ?? -1) - (ax ?? -1);
    });
    const best = sorted[0];
    const v = accessor(best);
    return `
      <div class="panel">
        <h3>${emoji} ${esc(title)}</h3>
        <ul class="ranklist">
          <li><span>${makePlayerClickable(best.player)}</span><span class="badge">${esc(formatter(v))}</span></li>
        </ul>
      </div>
    `;
  };

  const checkoutPanel = () => {
    const MIN_ATTEMPTS = 5; // ‚úÖ your requested minimum
    const eligible = arr
      .map(x => ({...x, cp: pct(x.cm, x.ca)}))
      .filter(x => x.cp !== null && x.ca >= MIN_ATTEMPTS)
      .sort((a,b) => b.cp - a.cp);

    if (!eligible.length){
      return `
        <div class="panel">
          <h3>‚úÖ Best Checkout % (League)</h3>
          <div class="muted">Not enough checkout data yet.</div>
        </div>
      `;
    }

    const best = eligible[0];
    return `
      <div class="panel">
        <h3>‚úÖ Best Checkout % (League)</h3>
        <ul class="ranklist">
          <li><span>${makePlayerClickable(best.player)}</span><span class="badge">${esc(fmtPct(best.cp))}</span></li>
        </ul>
        <div class="muted" style="margin-top:8px;">Min attempts: ${MIN_ATTEMPTS}</div>
      </div>
    `;
  };

  const html =
    topOne("Most 180s (League)", "üí•", x=>x.s180) +
    topOne("Most 140+ (League)", "üî•", x=>x.s140) +
    topOne("Most 100+ (League)", "üéØ", x=>x.s100) +
    topOne("Best Checkout (League)", "üèÜ", x=>x.hf) +
    checkoutPanel() +
    topOne("Best Leg (Lowest, League)", "‚ö°", x=>x.bl, v => (v==null? "‚Äî": v), "asc");

  document.getElementById("highlights").innerHTML = html;
}

/** Current Form (from Results) **/
let PLAYER_STATS_CACHE = null;
let RESULTS_CACHE = null;
let STAT_ENTRY_CACHE = null; // ‚úÖ cache Stat Entry as objects

function normName(s){
  return String(s ?? "").trim().toLowerCase().replace(/\s+/g, " ");
}

/** ‚úÖ Checkout % from Stat Entry (so modal never needs Player Stats totals) **/
function checkoutPctFromStatEntry(playerName){
  if (!STAT_ENTRY_CACHE) return null;

  const pn = normName(playerName);
  let made = 0, att = 0;

  for (const o of STAT_ENTRY_CACHE){
    const p = String(getAny(o, ["Player"]) || "").trim();
    if (normName(p) !== pn) continue;

    made += num(getAny(o, ["Checkout Made","Checkouts Made"]));
    att  += num(getAny(o, ["Checkout Attempts","Checkouts Attempted","Checkout Attempted"]));
  }
  return pct(made, att);
}

function buildCurrentForm(playerName, maxGames = 5){
  if (!RESULTS_CACHE) return [];

  const pn = normName(playerName);

  const H_HOME   = ["Home Player","Home"];
  const H_AWAY   = ["Away Player","Away"];
  const H_WINNER = ["Winner"];
  const H_LOSER  = ["Loser"];
  const H_DRAW   = ["Draw?","Draw"];
  const H_DATE   = ["Date"];

  const games = RESULTS_CACHE
    .map(o => ({
      date: String(getAny(o, H_DATE) ?? "").trim(),
      home: String(getAny(o, H_HOME) ?? "").trim(),
      away: String(getAny(o, H_AWAY) ?? "").trim(),
      winner: String(getAny(o, H_WINNER) ?? "").trim(),
      loser: String(getAny(o, H_LOSER) ?? "").trim(),
      draw: String(getAny(o, H_DRAW) ?? "").trim(),
    }))
    .filter(g => normName(g.home) === pn || normName(g.away) === pn);

  if (!games.length) return [];

  const parse = (d) => {
    const x = new Date(d);
    return isNaN(x) ? null : x.getTime();
  };

  const withT = games.map(g => ({...g, t: parse(g.date)}));
  const sortable = withT.some(g => g.t !== null);

  const ordered = sortable
    ? withT.sort((a,b) => (a.t ?? 0) - (b.t ?? 0))
    : withT;

  const last = ordered.slice(-maxGames).reverse(); // latest first

  return last.map(g => {
    const isDraw = String(g.draw).trim().toLowerCase();
    if (isDraw === "y" || isDraw === "yes" || isDraw === "true" || isDraw === "1") return "D";
    if (normName(g.winner) === pn) return "W";
    if (normName(g.loser) === pn) return "L";
    return "?";
  });
}

function renderFormPills(formLetters){
  if (!formLetters || !formLetters.length) return `<span class="muted">No recent results</span>`;

  const pillFor = (ch) => {
    if (ch === "W") return `<span class="badge" style="border-color: rgba(34,197,94,.55)">W</span>`;
    if (ch === "D") return `<span class="badge" style="border-color: rgba(234,179,8,.55)">D</span>`;
    if (ch === "L") return `<span class="badge" style="border-color: rgba(239,68,68,.55)">L</span>`;
    return `<span class="badge">?</span>`;
  };

  return `<div style="display:flex; gap:8px; flex-wrap:wrap;">${formLetters.map(pillFor).join("")}</div>`;
}

/** Player Profile Modal **/
function openModal(playerName){
  const backdrop = document.getElementById("modalBackdrop");
  const nameEl = document.getElementById("modalName");
  const bodyEl = document.getElementById("modalBody");

  nameEl.textContent = playerName;
  bodyEl.innerHTML = "Loading‚Ä¶";
  backdrop.style.display = "flex";
  backdrop.setAttribute("aria-hidden", "false");

  if (!PLAYER_STATS_CACHE){
    bodyEl.innerHTML = `<div class="error">Player Stats not loaded yet.</div>`;
    return;
  }

  const p = PLAYER_STATS_CACHE.find(x => (x["Player"] || "") === playerName);
  if (!p){
    bodyEl.innerHTML = `<div class="error">No profile data found for this player yet.</div>`;
    return;
  }

  const v = (k)=> p[k] ?? "";

  // ‚úÖ Checkout % computed from Stat Entry cache (works even if Player Stats has no checkout columns)
  const cpct = fmtPct(checkoutPctFromStatEntry(playerName));

  const html = `
    <div class="profile-grid">
      <div class="kpi">
        <h4>Record</h4>
        <div class="rows">
          <div class="row"><span>Matches</span><span>${esc(v("Matches"))}</span></div>
          <div class="row"><span>Wins / Draws / Losses</span><span>${esc(v("Wins"))} / ${esc(v("Draws"))} / ${esc(v("Losses"))}</span></div>
          <div class="row"><span>Legs Won / Lost</span><span>${esc(v("Legs Won"))} / ${esc(v("Legs Lost"))}</span></div>
        </div>
      </div>

      <div class="kpi">
        <h4>Scoring (Totals)</h4>
        <div class="rows">
          <div class="row"><span>60+</span><span>${esc(v("60+"))}</span></div>
          <div class="row"><span>80+</span><span>${esc(v("80+"))}</span></div>
          <div class="row"><span>100+</span><span>${esc(v("100+"))}</span></div>
          <div class="row"><span>140+</span><span>${esc(v("140+"))}</span></div>
          <div class="row"><span>180</span><span>${esc(v("180"))}</span></div>
        </div>
      </div>

      <div class="kpi">
        <h4>Records</h4>
        <div class="rows">
          <div class="row"><span>Highest Finish</span><span>${esc(v("Highest Finish") || "‚Äî")}</span></div>
          <div class="row"><span>Best Leg (Lowest)</span><span>${esc(v("Best Leg") || "‚Äî")}</span></div>
          <div class="row"><span>Checkout %</span><span>${esc(cpct)}</span></div>
        </div>
      </div>

      <div class="kpi">
        <h4>Current Form (Last 5)</h4>
        <div class="rows">
          <div class="row">
            <span>Latest ‚Üí Oldest</span>
            <span>${renderFormPills(buildCurrentForm(playerName, 5))}</span>
          </div>
        </div>
      </div>
    </div>
  `;

  bodyEl.innerHTML = html;
}

function closeModal(){
  const backdrop = document.getElementById("modalBackdrop");
  backdrop.style.display = "none";
  backdrop.setAttribute("aria-hidden", "true");
}

document.getElementById("modalClose").addEventListener("click", closeModal);
document.getElementById("modalBackdrop").addEventListener("click", (e) => {
  if (e.target.id === "modalBackdrop") closeModal();
});
document.addEventListener("keydown", (e) => {
  if (e.key === "Escape") closeModal();
});

// delegate player clicks
document.addEventListener("click", (e) => {
  const t = e.target.closest("[data-player]");
  if (!t) return;
  const name = t.getAttribute("data-player");
  if (name) openModal(name);
});

/** Load all **/
async function loadAll(){
  // League
  const leagueCSV = await fetch(csvUrl(LEAGUE_GID), {cache:"no-store"}).then(r => r.text());
  renderTable(parseCSV(leagueCSV), "league", ["player"]);

  // Averages
  const avgCSV = await fetch(csvUrl(AVERAGES_GID), {cache:"no-store"}).then(r => r.text());
  const avgRows = parseCSV(avgCSV);
  const avgHeaders = avgRows[0].map(h => String(h||"").trim().toLowerCase());
  const firstHeader = avgHeaders[0] || "player";
  renderTable(avgRows, "averages", [firstHeader]);

  // Fixtures
  const fixCSV = await fetch(csvUrl(FIXTURES_GID), {cache:"no-store"}).then(r => r.text());
  renderFixtures(parseCSV(fixCSV));

  // Player Stats
  const psCSV = await fetch(csvUrl(PLAYER_STATS_GID), {cache:"no-store"}).then(r => r.text());
  const psRows = parseCSV(psCSV);
  PLAYER_STATS_CACHE = rowsToObjects(psRows);

  // Records
  renderRecords(PLAYER_STATS_CACHE);

  // Stat Entry (cache + league highlights)
  const seCSV = await fetch(csvUrl(STAT_ENTRY_GID), {cache:"no-store"}).then(r => r.text());
  const seRows = parseCSV(seCSV);
  STAT_ENTRY_CACHE = rowsToObjects(seRows); // ‚úÖ cache objects for modal checkout %
  renderLeagueHighlights(seRows);

  // Results (for Current Form)
  const resCSV = await fetch(csvUrl(RESULTS_GID), {cache:"no-store"}).then(r => r.text());
  const resRows = parseCSV(resCSV);
  RESULTS_CACHE = rowsToObjects(resRows);
}

document.getElementById("refreshBtn").addEventListener("click", loadAll);
loadAll();
</script>

</body>
</html>
